name: Flutter CI

on:
    push:
        branches: [master, develop]
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review, edited]
        branches: [master, develop]
    workflow_dispatch:

jobs:
    flutter-checks:
        name: Flutter checks on ${{ matrix.os }} / ${{ matrix.channel }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                channel: [stable]
            fail-fast: false

        env:
            FLUTTER_ROOT: /opt/hostedtoolcache/flutter

        steps:
            - uses: actions/checkout@v4

            - name: Cache pub packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.pub-cache
                  key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}

            - name: Setup Java (Android build)
              if: matrix.os != 'macOS'
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: "17"

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: ${{ matrix.channel }}

            - name: Flutter doctor
              working-directory: bio_ai
              run: |
                  flutter --version
                  flutter doctor -v

            - name: Get dependencies
              working-directory: bio_ai
              run: flutter pub get

            - name: Format check (dart format)
              working-directory: bio_ai
              run: dart format --set-exit-if-changed .

            - name: Static analysis (flutter analyze)
              working-directory: bio_ai
              run: flutter analyze --no-fatal-infos

            - name: Run unit & widget tests
              working-directory: bio_ai
              run: flutter test --coverage

            - name: Build Android APK
              if: runner.os != 'macOS'
              working-directory: bio_ai
              run: flutter build apk --release

            - name: Upload Android APK
              if: runner.os != 'macOS'
              uses: actions/upload-artifact@v4
              with:
                  name: app-release-${{ matrix.os }}
                  path: bio_ai/build/app/outputs/flutter-apk/app-release.apk

            - name: Build Windows binary
              if: runner.os == 'Windows'
              working-directory: bio_ai
              run: flutter build windows --release

            - name: Upload Windows build
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: windows-build
                  path: bio_ai/build/windows/runner/Release

            - name: Build iOS (no codesign)
              if: runner.os == 'macOS'
              working-directory: bio_ai
              run: flutter build ios --no-codesign

            - name: Upload iOS build
              if: runner.os == 'macOS'
              uses: actions/upload-artifact@v4
              with:
                  name: ios-build
                  path: bio_ai/build/ios/iphoneos

            - name: Archive coverage
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage
                  path: bio_ai/coverage
