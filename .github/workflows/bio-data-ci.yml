name: "bio-data CI"

on:
  push:
    branches:
    - 'feat/data/*'
    paths:
    - 'bio-data/**'
  pull_request:
    branches:
    - 'feat/data/*'
    paths:
    - 'bio-data/**'
    types: [ opened, synchronize, reopened, edited ]
  workflow_dispatch: {}

concurrency:
  group: "bio-data-ci-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  detect:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      provider: ${{ steps.filter.outputs.provider }}
      embedding: ${{ steps.filter.outputs.embedding }}
    steps:
    - uses: actions/checkout@v4
    - name: Check changed paths
      uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          backend:
            - 'bio-data/backend/**'
          provider:
            - 'bio-data/provider/**'
          embedding:
            - 'bio-data/embedding_server/**'

  backend:
    name: Backend (Node.js) ✅
    needs: detect
    runs-on: ubuntu-latest
    if: needs.detect.outputs.backend == 'true' || startsWith(github.head_ref, 'feat/data/') || startsWith(github.ref, 'refs/heads/feat/data/')
    steps:
    - uses: actions/checkout@v4
    - name: Cache node modules / npm
      uses: actions/cache@v4
      with:
        path: |
          bio-data/backend/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('bio-data/backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    - name: Install dependencies
      working-directory: bio-data/backend
      run: |
        npm ci || npm install
    - name: Run lint (if present)
      working-directory: bio-data/backend
      run: |
        if node -e "console.log(Boolean(require('./package.json').scripts && require('./package.json').scripts.lint))" | grep -q true; then npm run lint; else echo "no lint script"; fi
    - name: Run tests (if present)
      working-directory: bio-data/backend
      run: |
        if node -e "console.log(Boolean(require('./package.json').scripts && require('./package.json').scripts.test))" | grep -q true; then npm test; else echo "no test script"; fi

  provider:
    name: Provider (Frontend) ✅
    needs: detect
    runs-on: ubuntu-latest
    if: needs.detect.outputs.provider == 'true' || startsWith(github.head_ref, 'feat/data/') || startsWith(github.ref, 'refs/heads/feat/data/')
    steps:
    - uses: actions/checkout@v4
    - name: Cache node modules / npm
      uses: actions/cache@v4
      with:
        path: |
          bio-data/provider/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('bio-data/provider/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    - name: Install dependencies
      working-directory: bio-data/provider
      run: |
        npm ci || npm install
    - name: Lint
      working-directory: bio-data/provider
      run: npm run lint
    - name: Build (sanity)
      working-directory: bio-data/provider
      run: npm run build --if-present

  embedding_server:
    name: Embedding Server (Python) ✅
    needs: detect
    runs-on: ubuntu-latest
    if: needs.detect.outputs.embedding == 'true' || startsWith(github.head_ref, 'feat/data/') || startsWith(github.ref, 'refs/heads/feat/data/')
    steps:
    - uses: actions/checkout@v4
    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('bio-data/embedding_server/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install Python dependencies
      working-directory: bio-data/embedding_server
      run: python -m pip install -r requirements.txt
    - name: Install flake8
      working-directory: bio-data/embedding_server
      run: python -m pip install flake8
    - name: Lint (flake8)
      working-directory: bio-data/embedding_server
      run: flake8 . || true
    - name: Run import smoke test
      working-directory: bio-data/embedding_server
      run: |
        python - <<'PY'
        import importlib, sys
        for pkg in ("fastapi","uvicorn","sentence_transformers"):
            try:
                importlib.import_module(pkg)
            except Exception as e:
                print("ERROR importing", pkg, e)
                sys.exit(1)
        print("Python deps import OK")
        PY
    - name: Run tests (if present)
      working-directory: bio-data/embedding_server
      run: |
        if [ -d tests ] || [ -f pytest.ini ]; then python -m pytest -q; else echo "No tests to run"; fi

  summary:
    name: Summary (optional notification)
    runs-on: ubuntu-latest
    needs: [ detect, backend, provider, embedding_server ]
    if: always()
    steps:
    - name: Print summary
      run: |
        echo "Backend changed: ${{ needs.detect.outputs.backend }}"
        echo "Provider changed: ${{ needs.detect.outputs.provider }}"
        echo "Embedding changed: ${{ needs.detect.outputs.embedding }}"

  pr_comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [ detect, backend, provider, embedding_server, summary ]
    if: github.event_name == 'pull_request'
    steps:
    - name: Create PR summary comment
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr = context.payload.pull_request;
          if (!pr) {
            console.log('No pull_request in context, aborting comment');
            return;
          }
          const body = `### CI Summary for PR #${pr.number}\n\n- Backend job: **${needs.backend.result}**\n- Provider job: **${needs.provider.result}**\n- Embedding job: **${needs.embedding.result}**\n\n**Detected changes:** backend=${{ needs.detect.outputs.backend }}, provider=${{ needs.detect.outputs.provider }}, embedding=${{ needs.detect.outputs.embedding }}\n`;
          await github.rest.issues.createComment({
            issue_number: pr.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body,
          });
